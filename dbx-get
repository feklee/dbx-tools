#!/bin/bash

source "`dirname $0`/init.sh"

NON_OPTION_ARGS="PATH"

DESCRIPTION=$(cat <<EOF
Download PATH from the Dropbox. If PATH is a directory, download its
contents recursively. Dropbox is case insensitive to file names. If a
file already exists locally, the case of its name is preserved.
EOF
	   )

parse-options "$@"
shift $((OPTIND-1))

P="$1"
shift && test -n "$P" || exit-on-missing-args

shopt -s nocasematch

function process-match {
    M=${BASH_REMATCH[0]}
    DBX_FILE="${LINE##$M}"
    ABS_LOCAL_FILE=`local-path "$DBX_FILE"`
    LOCAL_FILE="${ABS_LOCAL_FILE##$PWD/}"
}

DBX_PATH=`dbx-path "$P"`
dbxcli ls -Rl "$DBX_PATH" | \
    tail -n +2 | \
    while read LINE; do
	if [[ $LINE =~ ^-[[:blank:]]+-[[:blank:]]+-[[:blank:]]+ ]];
	then
	    process-match
	    ACTION="creating local directory $LOCAL_FILE"
	    mkdir -p "$LOCAL_FILE" && \
		echo "Success $ACTION" || \
		    exit-on-error "Failure $ACTION"
	elif [[ $LINE =~ ^[^/]+ ]]; then
	    process-match
	    ACTION="downloading $LOCAL_FILE"
	    dbxcli get "$DBX_FILE" "$LOCAL_FILE" && \
		echo "Success $ACTION" || \
		    exit-on-error "Failure $ACTION"
	fi
    done
